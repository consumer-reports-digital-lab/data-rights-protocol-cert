<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-03-21 Mon 10:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tools for the DRP Conformance Test Suite</title>
<meta name="author" content="Ryan Rix" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
<!--/*--><![CDATA[/*><!--*/
html {
    margin-left: auto;
    margin-right: auto;
    max-width: 768px;
}
/*]]>*/-->
</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Tools for the DRP Conformance Test Suite</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org939993c">1. Introduction and Setup</a>
<ul>
<li><a href="#org6b0d6f2">1.1. Alternatives</a>
<ul>
<li><a href="#orgdb9b7f9">1.1.1. Nix Dev Shell</a></li>
<li><a href="#org679d9c7">1.1.2. Fallback Dockerfile dev environment</a>
<ul>
<li><a href="#orgc48f890">1.1.2.1. <span class="todo NEXT">NEXT</span> Provide a <code>docker-compose.yml</code> to compose the swagger, status server, shell together</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org627dd4e">2. Utilities Provided by your System</a></li>
<li><a href="#org173a87e">3. <code>genjwts</code>: JWT generation script</a>
<ul>
<li><a href="#orgd8d5337">3.1. What about the secrets?</a>
<ul>
<li><a href="#org4a277d7">3.1.1. <span class="todo NEXT">NEXT</span> develop an interface for configuring the JWT security algorithms</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgdaedb87">4. <code>genreqs</code>: Rights Request generation script</a></li>
<li><a href="#orgcda8e2b">5. <span class="todo INPROGRESS">INPROGRESS</span> Test Suite's Request collection</a></li>
<li><a href="#org9c7242c">6. <code>openapi.yaml</code> and a Swagger server to submit to the PIP</a></li>
<li><a href="#org6fb849c">7. <code>statusserver</code> Status Callback Server</a>
<ul>
<li>
<ul>
<li><a href="#orgcd21a00">7.0.1. <span class="todo NEXT">NEXT</span> provide better guidance on tunneling setup</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org50e64e3">8. <span class="todo INPROGRESS">INPROGRESS</span> The Test Plan document</a></li>
<li><a href="#orgaf490ff">9. <span class="todo NEXT">NEXT</span> A spreadsheet to track and record Test Plan results</a></li>
</ul>
</div>
</div>

<div id="outline-container-org939993c" class="outline-2">
<h2 id="org939993c"><span class="section-number-2">1.</span> Introduction and Setup</h2>
<div class="outline-text-2" id="text-1">
<p>
These are simple utilities and test fixtures used to drive the <a href="../../../Code/data-rights-protocol/cert/pip-conformance-tests.html#ID-20211116T134053.585822">DRP Conformance Test Suite</a>.
</p>

<p>
They're all as simple as can be and written against Python 3.9. Please use a modern Python, the tools here make heavy use of modern Python features like type hinting to provide somewhat "magical" serialization and deserialization of Data Rights Requests.
</p>

<p>
I recommend installing Python 3.9 in accordance with your operating system's best principles<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>, and then install <a href="https://python-poetry.org/docs/">Poetry</a> following that documentation.
</p>

<div class="org-src-container">
<pre class="src src-shell">poetry install
poetry shell
</pre>
</div>

<p>
Creating virtualenv datarightsprotocol-SSQrMXUl-py3.9 in <i>home/rrix</i>.cache/pypoetry/virtualenvs
Spawning shell within <i>home/rrix</i>.cache/pypoetry/virtualenvs/datarightsprotocol-SSQrMXUl-py3.9
. <i>home/rrix</i>.cache/pypoetry/virtualenvs/datarightsprotocol-SSQrMXUl-py3.9/bin/activate
echo 'org<sub>babel</sub><sub>sh</sub><sub>eoe</sub>'
(datarightsprotocol-SSQrMXUl-py3.9)
</p>
</div>

<div id="outline-container-org6b0d6f2" class="outline-3">
<h3 id="org6b0d6f2"><span class="section-number-3">1.1.</span> Alternatives</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgdb9b7f9" class="outline-4">
<h4 id="orgdb9b7f9"><span class="section-number-4">1.1.1.</span> Nix Dev Shell</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
The developer of this suite uses a specialized Linux distribution called NixOS. Folks who use it or the <a href="https://nixos.org/">Nix Packaging Manager</a> it's built on can use the <code>shell.nix</code> provided to create a hermetic environment for the toolkit which can be instantiated via <a href="https://nixos.wiki/wiki/Development_environment_with_nix-shell">Nix Shell</a> command <code>nix-shell</code>.
</p>
</div>
</div>

<div id="outline-container-org679d9c7" class="outline-4">
<h4 id="org679d9c7"><span class="section-number-4">1.1.2.</span> Fallback Dockerfile dev environment</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
If you don't have a Linux environment available I <b>strongly recommend</b> setting one up or at least using Docker to get to a Linux environment with something like:
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #3b6ea8;">FROM</span> <span style="color: #9a7500; font-weight: bold;">fedora</span>
<span style="color: #3b6ea8;">VOLUME</span> /data <span style="color: #b1b1b1;"># </span><span style="color: #b1b1b1;">mount this directory here.</span>
<span style="color: #3b6ea8;">RUN</span> dnf install -y poetry jq curl bash
<span style="color: #b1b1b1;"># </span><span style="color: #b1b1b1;">pre-fetch deps</span>
<span style="color: #3b6ea8;">COPY</span> pyproject.toml /pyproject.toml 
<span style="color: #3b6ea8;">RUN</span> poetry install
<span style="color: #3b6ea8;">WORKDIR</span> /data
<span style="color: #3b6ea8;">ENV</span> <span style="color: #cb9aad; font-style: italic;">SHELL</span>=bash
<span style="color: #3b6ea8;">ENV</span> <span style="color: #cb9aad; font-style: italic;">PS1</span>=<span style="color: #4f894c;">"[drp-cert]# "</span>
<span style="color: #3b6ea8;">EXPOSE</span> 8000
<span style="color: #3b6ea8;">EXPOSE</span> 8001
<span style="color: #3b6ea8;">CMD</span> <span style="color: #4f894c;">"/usr/bin/bash"</span> <span style="color: #4f894c;">"-c"</span> <span style="color: #4f894c;">"poetry shell"</span>
</pre>
</div>

<p>
and invoking it with <a href="docker build . -t drp/cert &amp;&amp; docker run -it -p 8000:8000 -p 8001:8001 -v $PWD:/data drp/cert &amp;">docker build . -t drp/cert &amp;&amp; docker run -it -p 8000:8000 -p 8001:8001 -v $PWD:/data drp/cert</a>. Invoking it in this fashion will require you to run <code>poetry install</code> each time you open the shell, but the dependencies will already be downloaded and cached.
</p>
</div>

<div id="outline-container-orgc48f890" class="outline-5">
<h5 id="orgc48f890"><span class="section-number-5">1.1.2.1.</span> <span class="todo NEXT">NEXT</span> Provide a <code>docker-compose.yml</code> to compose the swagger, status server, shell together</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<p>
This whole "build the shell three times" is going to be tiring quite quickly. Until something like that is in place, work inside this micro-environment will not reliably persist, and data is not going to be shared between different instances of the same container &#x2013; at least provide guidance for using <code>docker exec</code> to enter in to the running shell.
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org627dd4e" class="outline-2">
<h2 id="org627dd4e"><span class="section-number-2">2.</span> Utilities Provided by your System</h2>
<div class="outline-text-2" id="text-2">
<p>
You'll need to have <a href="https://stedolan.github.io/jq/">JQ</a> installed. You'll need to have <a href="https://curl.se/">curl</a> installed.
</p>

<p>
Both of these will be available in any reasonable Linux package manager, the <code>homebrew</code> distribution.
</p>

<p>
They're even available even in the <a href="https://community.chocolatey.org/packages?q=jq">chocolatey</a> package manager for Windows, but this test suite <b>is not targeting or tested on Windows at the moment</b>.
</p>

<p>
They're included in the <code>nix-shell</code>.
</p>
</div>
</div>

<div id="outline-container-org173a87e" class="outline-2">
<h2 id="org173a87e"><span class="section-number-2">3.</span> <code>genjwts</code>: JWT generation script</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="./src/datarightsprotocol/tools/genjwts.py">tools/genjwts.py</a> is a script to generate JWTs signed by a bundled certificate as if it came from a test Authorized Agent.
</p>

<p>
This will only generate them but not decode or verify existing JWTs. Use <a href="https://jwt.io">the JWT Debugger</a> instead.
</p>

<div class="org-src-container">
<pre class="src src-shell">genjwts --help
</pre>
</div>

<p>
Usage: genjwts [OPTIONS]
</p>

<p>
Small utility function to generate an IdentityPayload and serialize it.
</p>

<p>
Options:
  -s, &#x2013;secret TEXT    JWT HS256 signing key
  -t, &#x2013;template TEXT  JWT template to populate
  -o, &#x2013;override TEXT  specify overrides to the JWT template in the form of
                       'claim=val'. can be specified repeatedly.
  -v, &#x2013;verify TEXT    specify claims to mark as 'verified'.
  &#x2013;help               Show this message and exit.
</p>

<p>
inside of <a href="./jwts">./jwts</a> we'll find some JSON templates which can be used with this tool:
</p>

<div class="org-src-container">
<pre class="src src-shell">genjwts -t jwts/simple.json
</pre>
</div>

<p>
Constructing claim.
Overriding template: []
Verifying claims: ()
</p>

<p>
Your JWT has arrived.
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.<sub>CbiyDqnorHtPwl</sub>-Z81y9m6f3tuhKDzFXSVu2qoJK14
</p>

<p>
All "debug" messages are sent to <code>STDERR</code> so you can safely use this in a shell pipeline or get only the JWT output to your terminal like:
</p>

<div class="org-src-container">
<pre class="src src-shell">genjwts -t jwts/simple.json 2&gt;/dev/null
</pre>
</div>

<p>
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.<sub>CbiyDqnorHtPwl</sub>-Z81y9m6f3tuhKDzFXSVu2qoJK14
</p>

<p>
claims can be overridden by passing any <code>--override</code> options:
</p>

<div class="org-src-container">
<pre class="src src-shell">genjwts -t jwts/simple.json -o <span style="color: #cb9aad; font-style: italic;">name</span>=<span style="color: #4f894c;">"ryan rix"</span> -o <span style="color: #cb9aad; font-style: italic;">email</span>=<span style="color: #4f894c;">"drp@rix.si"</span> 
</pre>
</div>

<p>
Constructing claim.
Overriding template: [['name', 'ryan rix'], ['email', 'drp@rix.si']]
Verifying claims: ()
</p>

<p>
Your JWT has arrived.
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoicnlhbiByaXgiLCJwb3dlcl9vZl9hdHRvcm5leSI6bnVsbCwiZW1haWwiOiJkcnBAcml4LnNpIiwicGhvbmVfbnVtYmVyIjoiMSA2MDIgNTU1IDEyMTIifQ.Sh9iZhDBc-9SyoDRBv7cZvuzlhtsrVE9OGcHVRoI4TI
</p>

<p>
claims can be marked as verified by passing any number of <code>--verify</code> options:
</p>

<div class="org-src-container">
<pre class="src src-shell">genjwts -t jwts/simple.json -v email
</pre>
</div>

<p>
Constructing claim.
Overriding template: []
Verifying claims: ('email',)
</p>

<p>
Your JWT has arrived.
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsX3ZlcmlmaWVkIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.RtaiT4cU83F4CDEU9WvgjWBxBTy9rzdy6Gh0c<sub>q6WXw</sub>
</p>
</div>

<div id="outline-container-orgd8d5337" class="outline-3">
<h3 id="orgd8d5337"><span class="section-number-3">3.1.</span> What about the secrets?</h3>
<div class="outline-text-3" id="text-3-1">
<p>
This thing basically only supports <code>HS256</code> signature-only JWTs in its current implementation, and loads the secret from an environment variable <code>JWT_SECRET</code>. So:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #29838d;">export</span> <span style="color: #cb9aad; font-style: italic;">JWT_SECRET</span>=<span style="color: #4f894c;">''</span>; <span style="color: #29838d;">echo</span> secret is $<span style="color: #cb9aad; font-style: italic;">JWT_SECRET</span> <span style="color: #b1b1b1;"># </span><span style="color: #b1b1b1;">default embedded in the code!</span>
genjwts -t jwts/simple.json 2&gt;/dev/null
<span style="color: #29838d;">export</span> <span style="color: #cb9aad; font-style: italic;">JWT_SECRET</span>=<span style="color: #4f894c;">'thisisdifferent!'</span>; <span style="color: #29838d;">echo</span> secret is $<span style="color: #cb9aad; font-style: italic;">JWT_SECRET</span>
genjwts -t jwts/simple.json 2&gt;/dev/null
</pre>
</div>

<p>
secret is
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.<sub>CbiyDqnorHtPwl</sub>-Z81y9m6f3tuhKDzFXSVu2qoJK14
secret is thisisdifferent!
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.xf9KcMqiUE1x<sub>JramIup5SVtAwWHcu</sub><sub>2EPTiSTT</sub>-ByA
</p>

<p>
It will need to be extended to support referring to an x509 certificate or multiple to support testing JWT encryption, and the x509 signatures which are required to enclose the trust network of a DRP implementers' network.
</p>
</div>

<div id="outline-container-org4a277d7" class="outline-4">
<h4 id="org4a277d7"><span class="section-number-4">3.1.1.</span> <span class="todo NEXT">NEXT</span> develop an interface for configuring the JWT security algorithms</h4>
</div>
</div>
</div>

<div id="outline-container-orgdaedb87" class="outline-2">
<h2 id="orgdaedb87"><span class="section-number-2">4.</span> <code>genreqs</code>: Rights Request generation script</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="./src/datarightsprotocol/tools/genreqs.py">tools/genreqs.py</a> composes with the JWT generation script to create entire Data Rights Requests. Like the JWT generation script, <code>stderr</code> can be stuff in to <code>/dev/null</code> for cleaner output.
</p>

<div class="org-src-container">
<pre class="src src-shell">genreqs --help
</pre>
</div>

<p>
Usage: genreqs [OPTIONS]
</p>

<p>
Small utility function to generate a DataRightsRequest and serialize it.
</p>

<p>
Options:
  -t, &#x2013;template FILENAME  DRR template to populate.
  -j, &#x2013;jwt FILENAME       Generate a JWT using the specified template,
                           otherwise read a serialized JWT from stdin (&amp;
                           probably out of genjwts.py)
  -o, &#x2013;override TEXT      Specify overrides to DRR values. Values specified
                           as a list will be overwritten on first override,
                           then appended to after, if that makes sense.
  &#x2013;help                   Show this message and exit.
</p>

<p>
In <a href="./reqs/">./reqs</a> we'll find some files containing JSON templates for the base Data Rights Requests.
</p>

<p>
In its default invocation, it will attempt to read a JWT from <code>stdin</code> &#x2013; pass a <code>--jwt</code> argument to specify a default JSON template with the default <code>genjwts</code> invocation.
</p>

<div class="org-src-container">
<pre class="src src-shell">genreqs -t reqs/donotsell.json -j jwts/simple.json 2&gt;/dev/null
</pre>
</div>

<p>
{"meta": {"version": "0.4"}, "relationships": [], "regime": "ccpa", "exercise": ["sale:opt-out"], "identity": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.<sub>CbiyDqnorHtPwl</sub>-Z81y9m6f3tuhKDzFXSVu2qoJK14"}
</p>

<p>
To create customized JWTs, use the <code>stdin</code> invocation (note that each invocation needs its <code>stderr</code> stuffed!):
</p>

<div class="org-src-container">
<pre class="src src-shell">genjwts -v email 2&gt;/dev/null | genreqs -t reqs/donotsell.json 2&gt;/dev/null
</pre>
</div>

<p>
{
  "meta": {
    "version": "0.4"
  },
  "relationships": [],
  "regime": "ccpa",
  "exercise": [
    "sale:opt-out"
  ],
  "identity": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsX3ZlcmlmaWVkIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.RtaiT4cU83F4CDEU9WvgjWBxBTy9rzdy6Gh0c<sub>q6WXw\n</sub>"
}
</p>

<p>
Overrides can be set in the <code>genreqs</code> script:
</p>

<div class="org-src-container">
<pre class="src src-shell">genreqs -j jwts/simple.json -t reqs/donotsell.json -o <span style="color: #cb9aad; font-style: italic;">regime</span>=voluntary 2&gt;/dev/null
</pre>
</div>

<p>
{"meta": {"version": "0.4"}, "relationships": [], "regime": ["voluntary"], "exercise": ["sale:opt-out"], "identity": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwaXAtdGVzdC1zdWl0ZSIsImF1ZCI6InRoZS1waXAiLCJzdWIiOiJ0aGUtY29uc3VtZXIiLCJuYW1lIjoidGhlLWNvbnN1bWVyIiwicG93ZXJfb2ZfYXR0b3JuZXkiOm51bGwsImVtYWlsIjoidGVzdGNvbnN1bWVyQGNvbnN1bWVyLm9yZyIsInBob25lX251bWJlciI6IjEgNjAyIDU1NSAxMjEyIn0.<sub>CbiyDqnorHtPwl</sub>-Z81y9m6f3tuhKDzFXSVu2qoJK14"}
</p>
</div>
</div>

<div id="outline-container-orgcda8e2b" class="outline-2">
<h2 id="orgcda8e2b"><span class="section-number-2">5.</span> <span class="todo INPROGRESS">INPROGRESS</span> Test Suite's Request collection</h2>
<div class="outline-text-2" id="text-5">
<p>
each DRR will be used to validate the "happy path" protocol guardrails, each will be used to exercise 3-5 time to validate that the PIP workflow can move between the multiplicative of <code>rights action * valid end state</code> and maybe one or two constants like CCPA v. voluntary compliance regulatory regimes.
</p>

<p>
Each one will have a JWT that'll need to be composed with the above generation script&#x2026;
</p>
</div>
</div>

<div id="outline-container-org9c7242c" class="outline-2">
<h2 id="org9c7242c"><span class="section-number-2">6.</span> <code>openapi.yaml</code> and a Swagger server to submit to the PIP</h2>
<div class="outline-text-2" id="text-6">
<p>
the <a href="https://www.openapis.org/">OpenAPI</a> specification is a machine-readable description schema for describing APIs on the web. We'll be using this with a tool called <a href="https://swagger.io/">Swagger</a> which provides an web app that can submit requests to APIs based on that <code>openapi</code> spec. This combination will allow for the "DRP certifier" to submit DRRs copied out of static JSON files or construct their own with DRRs generated by the above tooling.
</p>

<p>
<a href="openapi.yaml">openapi.yaml</a> provides a PIP-interface YAML specification. It can be used to submit DRP requests to a PIP instance and is foundational for the tests in the DRP <a href="pip-conformance-tests.html">conformance tests</a>.
</p>

<p>
<b>Be sure to edit <code>openapi.yaml</code>'s servers list to add your instance</b>
</p>

<p>
After running <code>poetry shell</code>, the command <code>swagger</code> will start this HTTP server.
</p>

<div class="org-src-container">
<pre class="src src-shell">swagger --help
</pre>
</div>

<p>
Usage: swagger [OPTIONS]

  start the DRP swagger tool.

Options:
  -h, &#x2013;host TEXT     the host IP to listen on, defaults to all IPs/interfaces
  -p, &#x2013;port INTEGER  port to listen on
  &#x2013;help              Show this message and exit.
</p>

<p>
changing the <code>DRP_OPENAPI</code> environment variable to point to another <code>openapi.yaml</code> or <code>swagger.json</code> file is the only other useful configuration element.<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>
</p>

<p>
Running <code>swagger</code> will print the URL it is visible on in the terminal output, but by default it is <a href="http://0.0.0.0:8001/swagger">here on port 8001</a>.
</p>
</div>
</div>

<div id="outline-container-org6fb849c" class="outline-2">
<h2 id="org6fb849c"><span class="section-number-2">7.</span> <code>statusserver</code> Status Callback Server</h2>
<div class="outline-text-2" id="text-7">
<p>
Recall that the DRP specification defines a "<a href="https://github.com/rrix/data-rights-protocol/blob/main/data-rights-protocol.md#204-post-status_callback-data-rights-status-callback-endpoint"><code>status_callback</code></a>" which is to be implemented by the <b>Authorized Agent</b> so that the <b>Privacy Infrastructure Provider or Covered Business</b> can push status changes to the AA rather than force the AA to poll a server every hour or day.
</p>

<p>
To test this flow, though, we need a server which has two endpoints:
</p>

<ul class="org-ul">
<li>an HTTP POST receiver which can be set as the callback server in the <code>/exercise</code> request, it does nothing but log the Data Rights Status to a local database with a 2-3 day retention policy applied to the data.</li>
<li><code>GET /status?request_id=FOO</code> which can be queried by the certifier to list all of the state transitions recorded for the given request ID.</li>
</ul>

<p>
In <a href="status_server.py">status<sub>server.py</sub></a> there is a dead-simple FastAPI server in less than 100 lines of Python which will behave as a status callback server and persist DRP status updates to disk.
</p>

<p>
[nb: i know i should provide better/stronger guidance here, this will "boil up" to a setup doc at the top of this with a full set of recommendations perhaps getting it running in a Docker container which can be hosted or run locally &#x2026;]
</p>

<p>
Invoke it from the DRP git checkout: <code>uvicorn status_server:app</code> and browse to <a href="http://localhost:8000">http://localhost:8000</a>.
</p>

<p>
Now, somehow, this needs to be hosted on the World Wide Web so that your PIP implementation can contact it. <a href="https://ngrok.com/">ngrok</a> and <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup">cloudflared tunnel</a> are the best recommendations the author has for this at the moment, both offer free accounts, but you may consider hosting this somewhere.
</p>
</div>

<div id="outline-container-orgcd21a00" class="outline-4">
<h4 id="orgcd21a00"><span class="section-number-4">7.0.1.</span> <span class="todo NEXT">NEXT</span> provide better guidance on tunneling setup</h4>
<div class="outline-text-4" id="text-7-0-1">
<p>
just pick a tool, give installation guidance, free account setup, create a command which starts the tunnel tool, grabs the URL for you to put in DRRs
</p>
</div>
</div>
</div>

<div id="outline-container-org50e64e3" class="outline-2">
<h2 id="org50e64e3"><span class="section-number-2">8.</span> <span class="todo INPROGRESS">INPROGRESS</span> The <a href="../../../Code/data-rights-protocol/cert/pip-conformance-tests.html#ID-20220209T171652.987733">Test Plan</a> document</h2>
<div class="outline-text-2" id="text-8">
<p>
That is what this document is shaping up to be so far &#x2013; a set of Test Cases, the inputs that go in to them, and simple scripts which can be used to validate the request on any UNIX-like system with a handful of tools installed in it. (i suppose we could just ship this in a docker container too)
</p>
</div>
</div>

<div id="outline-container-orgaf490ff" class="outline-2">
<h2 id="orgaf490ff"><span class="section-number-2">9.</span> <span class="todo NEXT">NEXT</span> A spreadsheet to track and record Test Plan results</h2>
<div class="outline-text-2" id="text-9">
<p>
In a "perfect world" we would all use Emacs Org-mode and this document could be the test-plan but <b>also</b> execute the test plan but <b>also</b> collect and bubble up the results within the document for reporting. But I'm not going to ask you to use an obscure markup language to work with this system.
</p>

<p>
Instead, you get a spreadsheet which can be used to collect the results of each test plan for review, and this will link back to the test plan document where appropriate.
</p>

<p>
This spreadsheet will be used to refine the database schema for a future automated test suite.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I will note that the author has not verified that this works on macOS or Windows. There is an assumption within this document and the Test Suite that you will have access to a POSIX-style shell. I have no idea how <code>poetry shell</code> works in cmd.exe or powershell, I would highly recommend setting up a WSL2 system. My apologies.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Unfortunately it's not so simple to add a command line flag because of how the FastAPI uvicorn app is instantiated, we don't have access to the <code>click</code> command line flags..
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Ryan Rix</p>
<p class="date">Created: 2022-03-21 Mon 10:43</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
